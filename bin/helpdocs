#!/usr/bin/env python3

# Copyright (c) 2023 Dirk Leas
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

#
# helpdocs - generate markdown help summary for all miditoyz commands, assumes
#            miditoyz in PATH
#
# todo:
#   - tbd
#

import os, re, subprocess, typer

help_text = """
# miditoyz
here's a full list of all the `miditoyz` command help generated by 
calling `miditoyz --help` and `miditoyz <command> --help` for each 
command:

"""


def extract_commands(code: str) -> list:
    pattern = r"@app\.command\(\)\s*def\s+([a-zA-Z_]\w*)\("
    return re.findall(pattern, code)


def main(
    cli: str = typer.Argument("miditoyz", help="CLI app to document."),
    license: bool = typer.Option(False, "--license", "-l", help="Include MIT license."),
):
    """Generate markdown help summary for a CLI application including all commands."""
    global help_text
    help_text = help_text.replace("miditoyz", cli)
    basic_help = subprocess.run(
        [f"{cli} --help"], capture_output=True, text=True, shell=True
    ).stdout
    help = f"{help_text}```{os.linesep}$ {cli} --help{os.linesep}{basic_help}"
    for command in extract_commands(open(cli).read()):
        help += f"{os.linesep}$ {cli} {command} --help{os.linesep}{subprocess.run([f'{cli} {command} --help'], capture_output=True, text=True, shell=True).stdout}"
    typer.echo(f"{help}```")
    if license:
        typer.echo(
            f"{os.linesep*2}--{os.linesep*2}This project is licensed under the terms of the MIT license. See LICENSE for details."
        )


if __name__ == "__main__":
    typer.run(main)
